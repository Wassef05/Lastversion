import { ChangeDetectionStrategy, Component, EventEmitter, Injector, Input, NgZone, Output, Renderer2, ViewChild, } from '@angular/core';
import { isComponent, isTemplateRef } from '@ngneat/overview';
import { ENTER_ANIMATION_DURATION, EXIT_ANIMATION_DURATION } from '../../constants';
import { HotToastRef } from '../../hot-toast-ref';
import { animate } from '../../utils';
export class HotToastComponent {
    constructor(injector, renderer, ngZone) {
        this.injector = injector;
        this.renderer = renderer;
        this.ngZone = ngZone;
        this.offset = 0;
        this.height = new EventEmitter();
        this.beforeClosed = new EventEmitter();
        this.afterClosed = new EventEmitter();
        this.isManualClose = false;
        this.unlisteners = [];
    }
    ngOnInit() {
        if (isTemplateRef(this.toast.message)) {
            this.context = { $implicit: this.toastRef };
        }
        if (isComponent(this.toast.message)) {
            this.toastComponentInjector = Injector.create({
                providers: [
                    {
                        provide: HotToastRef,
                        useValue: this.toastRef,
                    },
                ],
                parent: this.toast.injector || this.injector,
            });
        }
    }
    ngAfterViewInit() {
        const nativeElement = this.toastBarBase.nativeElement;
        // Caretaker note: accessing `offsetHeight` triggers the whole layout update.
        // Macro tasks (like `setTimeout`) might be executed within the current rendering frame and cause a frame drop.
        requestAnimationFrame(() => {
            this.height.emit(nativeElement.offsetHeight);
        });
        // Caretaker note: `animationstart` and `animationend` events are event tasks that trigger change detection.
        // We'd want to trigger the change detection only if it's an exit animation.
        this.ngZone.runOutsideAngular(() => {
            this.unlisteners.push(
            // Caretaker note: we have to remove these event listeners at the end (even if the element is removed from DOM).
            // zone.js stores its `ZoneTask`s within the `nativeElement[Zone.__symbol__('animationstart') + 'false']` property
            // with callback that capture `this`.
            this.renderer.listen(nativeElement, 'animationstart', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.beforeClosed.emit());
                }
            }), this.renderer.listen(nativeElement, 'animationend', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.afterClosed.emit({ dismissedByAction: this.isManualClose, id: this.toast.id }));
                }
            }));
        });
        this.setToastAttributes();
    }
    get containerPositionStyle() {
        const top = this.toast.position.includes('top');
        const verticalStyle = top ? { top: 0 } : { bottom: 0 };
        const horizontalStyle = this.toast.position.includes('left')
            ? {
                left: 0,
            }
            : this.toast.position.includes('right')
                ? {
                    right: 0,
                }
                : {
                    left: 0,
                    right: 0,
                    justifyContent: 'center',
                };
        return Object.assign(Object.assign({ transform: `translateY(${this.offset * (top ? 1 : -1)}px)` }, verticalStyle), horizontalStyle);
    }
    get toastBarBaseStyles() {
        const top = this.toast.position.includes('top');
        const enterAnimation = `hotToastEnterAnimation${top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const exitAnimation = `hotToastExitAnimation${top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1) ${this.toast.duration}ms`;
        const animation = this.toast.autoClose ? `${enterAnimation}, ${exitAnimation}` : enterAnimation;
        return Object.assign(Object.assign({}, this.toast.style), { animation });
    }
    get isIconString() {
        return typeof this.toast.icon === 'string';
    }
    close() {
        this.isManualClose = true;
        const top = this.toast.position.includes('top');
        const exitAnimation = `hotToastExitAnimation${top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
    }
    ngOnDestroy() {
        this.close();
        while (this.unlisteners.length) {
            this.unlisteners.pop()();
        }
    }
    isExitAnimation(ev) {
        return ev.animationName.includes('hotToastExitAnimation');
    }
    setToastAttributes() {
        const toastAttributes = this.toast.attributes;
        for (const [key, value] of Object.entries(toastAttributes)) {
            this.renderer.setAttribute(this.toastBarBase.nativeElement, key, value);
        }
    }
}
HotToastComponent.decorators = [
    { type: Component, args: [{
                selector: 'hot-toast',
                template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n>\n  <div\n    class=\"hot-toast-bar-base\"\n    #hotToastBarBase\n    [ngStyle]=\"toastBarBaseStyles\"\n    [ngClass]=\"toast.className\"\n    [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n    [attr.aria-live]=\"toast.ariaLive\"\n    [attr.role]=\"toast.role\"\n  >\n    <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n      <ng-container *ngIf=\"toast.icon !== undefined; else indicator\">\n        <ng-container *ngIf=\"isIconString; else iconTemplateOrComponent\">\n          <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n        </ng-container>\n        <ng-template #iconTemplateOrComponent>\n          <div>\n            <ng-container [dynamicView]=\"toast.icon\"></ng-container>\n          </div>\n        </ng-template>\n      </ng-container>\n\n      <ng-template #indicator>\n        <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n      </ng-template>\n    </div>\n\n    <div class=\"hot-toast-message\">\n      <div>\n        <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n      </div>\n    </div>\n\n    <button\n      *ngIf=\"toast.dismissible\"\n      (click)=\"close()\"\n      type=\"button\"\n      class=\"hot-toast-close-btn\"\n      aria-label=\"Close\"\n      [ngStyle]=\"toast.closeStyle\"\n    ></button>\n  </div>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".hot-toast-bar-base{align-items:var(--hot-toast-align-items,center);background-color:var(--hot-toast-bg,#fff);border-radius:var(--hot-toast-border-radius,4px);box-shadow:var(--hot-toast-shadow,0 3px 10px rgba(0,0,0,.1),0 3px 3px rgba(0,0,0,.05));color:var(--hot-toast-color,#363636);display:var(--hot-toast-display,flex);line-height:var(--hot-toast-line,1.3);margin:var(--hot-toast-margin,16px);max-width:var(--hot-toast-max-width,350px);padding:var(--hot-toast-padding,8px 10px);pointer-events:var(--hot-toast-pointer-events,auto);width:var(--hot-toast-width,-webkit-fit-content);width:var(--hot-toast-width,-moz-fit-content);width:var(--hot-toast-width,fit-content);will-change:var(--hot-toast-will-change,transform)}.hot-toast-bar-base:focus,.hot-toast-bar-base:hover{animation-play-state:var(--hot-toast-animation-state,paused)!important}@media (prefers-reduced-motion:reduce){.hot-toast-bar-base{animation-duration:var(--hot-toast-reduced-motion-animation-duration,10ms)!important}}.hot-toast-message{color:var(--hot-toast-message-color,inherit);display:var(--hot-toast-message-display,flex);flex:var(--hot-toast-message-flex,1);justify-content:var(--hot-toast-message-justify-content,center);margin:var(--hot-toast-message-margin,4px 10px)}.hot-toast-bar-base-container{display:var(--hot-toast-container-display,flex);pointer-events:var(--hot-toast-container-pointer-events,none);position:var(--hot-toast-container-position,absolute);transition:var(--hot-toast-container-transition,transform .23s cubic-bezier(.21,1.02,.73,1))}@media (prefers-reduced-motion:reduce){.hot-toast-bar-base-container{transition-duration:var(--hot-toast-container-reduced-motion-transition-duration,10ms)!important}}.hot-toast-bar-base-container.hot-toast-theme-snackbar .hot-toast-bar-base{background:var(--hot-toast-snackbar-bg,#323232);box-shadow:var(--hot-toast-snackbar-shadow,0 3px 5px -1px rgba(0,0,0,.2),0 6px 10px 0 rgba(0,0,0,.14),0 1px 18px 0 rgba(0,0,0,.12));color:var(--hot-toast-snackbar-color,#fff)}.hot-toast-bar-base-container.hot-toast-theme-snackbar .hot-toast-close-btn{filter:var(--hot-toast-snackbar-close-btn-filter,invert(1) grayscale(100%) brightness(200%))}@keyframes hotToastEnterAnimationNegative{0%{opacity:.5;transform:translate3d(0,-80px,0) scale(.6)}to{opacity:1;transform:translateZ(0) scale(1)}}@keyframes hotToastEnterAnimationPositive{0%{opacity:.5;transform:translate3d(0,80px,0) scale(.6)}to{opacity:1;transform:translateZ(0) scale(1)}}@keyframes hotToastExitAnimationPositive{0%{opacity:1;transform:translateZ(-1px) scale(1)}to{opacity:0;transform:translate3d(0,130px,-1px) scale(.5)}}@keyframes hotToastExitAnimationNegative{0%{opacity:1;transform:translateZ(-1px) scale(1)}to{opacity:0;transform:translate3d(0,-130px,-1px) scale(.5)}}.hot-toast-close-btn{align-self:var(--hot-toast-close-btn-align-self,flex-start);background-color:var(--hot-toast-close-btn-background-color,transparent);background-image:var(--hot-toast-close-btn-background-image,url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e\"));background-position:var(--hot-toast-close-btn-background-position,center);background-repeat:var(--hot-toast-close-btn-background-repeat,no-repeat);background-size:var(--hot-toast-close-btn-background-size,.75em);border:var(--hot-toast-close-btn-border,0);border-radius:var(--hot-toast-close-btn-border-radius,.25rem);box-sizing:var(--hot-toast-close-btn-box-sizing,content-box);display:var(--hot-toast-close-btn-display,flex);height:var(--hot-toast-close-btn-height,.8em);margin-top:var(--hot-toast-close-btn-margin-top,.25em);opacity:var(--hot-toast-close-btn-opacity,.5);padding:var(--hot-toast-close-btn-padding,.25em);width:var(--hot-toast-close-btn-width,.8em)}.hot-toast-close-btn:focus{box-shadow:var(--hot-toast-close-btn-box-shadow,0 0 0 .125rem rgba(13,110,253,.25));outline:var(--hot-toast-close-btn-outline,none)}.hot-toast-close-btn:focus,.hot-toast-close-btn:hover{opacity:var(--hot-toast-close-btn-opacity,.75)}.hot-toast-icon{align-self:var(--hot-toast-icon-align-self,flex-start);padding-top:var(--hot-toast-icon-padding-top,.25em)}"]
            },] }
];
HotToastComponent.ctorParameters = () => [
    { type: Injector },
    { type: Renderer2 },
    { type: NgZone }
];
HotToastComponent.propDecorators = {
    toast: [{ type: Input }],
    offset: [{ type: Input }],
    defaultConfig: [{ type: Input }],
    toastRef: [{ type: Input }],
    height: [{ type: Output }],
    beforeClosed: [{ type: Output }],
    afterClosed: [{ type: Output }],
    toastBarBase: [{ type: ViewChild, args: ['hotToastBarBase',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvaG90LXRvYXN0L3NyYy8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hvdC10b2FzdC9ob3QtdG9hc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUVULFlBQVksRUFDWixRQUFRLEVBQ1IsS0FBSyxFQUNMLE1BQU0sRUFHTixNQUFNLEVBQ04sU0FBUyxFQUNULFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzlELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBUXRDLE1BQU0sT0FBTyxpQkFBaUI7SUFrQjVCLFlBQW9CLFFBQWtCLEVBQVUsUUFBbUIsRUFBVSxNQUFjO1FBQXZFLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWhCbEYsV0FBTSxHQUFHLENBQUMsQ0FBQztRQUlWLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBQ3BDLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNsQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFpQixDQUFDO1FBSTFELGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBSWQsZ0JBQVcsR0FBbUIsRUFBRSxDQUFDO0lBRXFELENBQUM7SUFFL0YsUUFBUTtRQUNOLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FB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QVMsU0FBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgTmdab25lLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBSZW5kZXJlcjIsXG4gIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc0NvbXBvbmVudCwgaXNUZW1wbGF0ZVJlZiB9IGZyb20gJ0BuZ25lYXQvb3ZlcnZpZXcnO1xuaW1wb3J0IHsgRU5URVJfQU5JTUFUSU9OX0RVUkFUSU9OLCBFWElUX0FOSU1BVElPTl9EVVJBVElPTiB9IGZyb20gJy4uLy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBIb3RUb2FzdFJlZiB9IGZyb20gJy4uLy4uL2hvdC10b2FzdC1yZWYnO1xuaW1wb3J0IHsgQ3JlYXRlSG90VG9hc3RSZWYsIEhvdFRvYXN0Q2xvc2UsIFRvYXN0LCBUb2FzdENvbmZpZyB9IGZyb20gJy4uLy4uL2hvdC10b2FzdC5tb2RlbCc7XG5pbXBvcnQgeyBhbmltYXRlIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdob3QtdG9hc3QnLFxuICB0ZW1wbGF0ZVVybDogJ2hvdC10b2FzdC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2hvdC10b2FzdC5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgSG90VG9hc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIHRvYXN0OiBUb2FzdDx1bmtub3duPjtcbiAgQElucHV0KCkgb2Zmc2V0ID0gMDtcbiAgQElucHV0KCkgZGVmYXVsdENvbmZpZzogVG9hc3RDb25maWc7XG4gIEBJbnB1dCgpIHRvYXN0UmVmOiBDcmVhdGVIb3RUb2FzdFJlZjx1bmtub3duPjtcblxuICBAT3V0cHV0KCkgaGVpZ2h0ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIEBPdXRwdXQoKSBiZWZvcmVDbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBhZnRlckNsb3NlZCA9IG5ldyBFdmVudEVtaXR0ZXI8SG90VG9hc3RDbG9zZT4oKTtcblxuICBAVmlld0NoaWxkKCdob3RUb2FzdEJhckJhc2UnKSBwcml2YXRlIHRvYXN0QmFyQmFzZTogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG5cbiAgaXNNYW51YWxDbG9zZSA9IGZhbHNlO1xuICBjb250ZXh0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICB0b2FzdENvbXBvbmVudEluamVjdG9yOiBJbmplY3RvcjtcblxuICBwcml2YXRlIHVubGlzdGVuZXJzOiBWb2lkRnVuY3Rpb25bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsIHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKGlzVGVtcGxhdGVSZWYodGhpcy50b2FzdC5tZXNzYWdlKSkge1xuICAgICAgdGhpcy5jb250ZXh0ID0geyAkaW1wbGljaXQ6IHRoaXMudG9hc3RSZWYgfTtcbiAgICB9XG4gICAgaWYgKGlzQ29tcG9uZW50KHRoaXMudG9hc3QubWVzc2FnZSkpIHtcbiAgICAgIHRoaXMudG9hc3RDb21wb25lbnRJbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7XG4gICAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IEhvdFRvYXN0UmVmLFxuICAgICAgICAgICAgdXNlVmFsdWU6IHRoaXMudG9hc3RSZWYsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgcGFyZW50OiB0aGlzLnRvYXN0LmluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG4gICAgLy8gQ2FyZXRha2VyIG5vdGU6IGFjY2Vzc2luZyBgb2Zmc2V0SGVpZ2h0YCB0cmlnZ2VycyB0aGUgd2hvbGUgbGF5b3V0IHVwZGF0ZS5cbiAgICAvLyBNYWNybyB0YXNrcyAobGlrZSBgc2V0VGltZW91dGApIG1pZ2h0IGJlIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCByZW5kZXJpbmcgZnJhbWUgYW5kIGNhdXNlIGEgZnJhbWUgZHJvcC5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgdGhpcy5oZWlnaHQuZW1pdChuYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodCk7XG4gICAgfSk7XG5cbiAgICAvLyBDYXJldGFrZXIgbm90ZTogYGFuaW1hdGlvbnN0YXJ0YCBhbmQgYGFuaW1hdGlvbmVuZGAgZXZlbnRzIGFyZSBldmVudCB0YXNrcyB0aGF0IHRyaWdnZXIgY2hhbmdlIGRldGVjdGlvbi5cbiAgICAvLyBXZSdkIHdhbnQgdG8gdHJpZ2dlciB0aGUgY2hhbmdlIGRldGVjdGlvbiBvbmx5IGlmIGl0J3MgYW4gZXhpdCBhbmltYXRpb24uXG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy51bmxpc3RlbmVycy5wdXNoKFxuICAgICAgICAvLyBDYXJldGFrZXIgbm90ZTogd2UgaGF2ZSB0byByZW1vdmUgdGhlc2UgZXZlbnQgbGlzdGVuZXJzIGF0IHRoZSBlbmQgKGV2ZW4gaWYgdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIERPTSkuXG4gICAgICAgIC8vIHpvbmUuanMgc3RvcmVzIGl0cyBgWm9uZVRhc2tgcyB3aXRoaW4gdGhlIGBuYXRpdmVFbGVtZW50W1pvbmUuX19zeW1ib2xfXygnYW5pbWF0aW9uc3RhcnQnKSArICdmYWxzZSddYCBwcm9wZXJ0eVxuICAgICAgICAvLyB3aXRoIGNhbGxiYWNrIHRoYXQgY2FwdHVyZSBgdGhpc2AuXG4gICAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKG5hdGl2ZUVsZW1lbnQsICdhbmltYXRpb25zdGFydCcsIChldmVudDogQW5pbWF0aW9uRXZlbnQpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5pc0V4aXRBbmltYXRpb24oZXZlbnQpKSB7XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5iZWZvcmVDbG9zZWQuZW1pdCgpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICB0aGlzLnJlbmRlcmVyLmxpc3RlbihuYXRpdmVFbGVtZW50LCAnYW5pbWF0aW9uZW5kJywgKGV2ZW50OiBBbmltYXRpb25FdmVudCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmlzRXhpdEFuaW1hdGlvbihldmVudCkpIHtcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmFmdGVyQ2xvc2VkLmVtaXQoeyBkaXNtaXNzZWRCeUFjdGlvbjogdGhpcy5pc01hbnVhbENsb3NlLCBpZDogdGhpcy50b2FzdC5pZCB9KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRoaXMuc2V0VG9hc3RBdHRyaWJ1dGVzKCk7XG4gIH1cblxuICBnZXQgY29udGFpbmVyUG9zaXRpb25TdHlsZSgpIHtcbiAgICBjb25zdCB0b3AgPSB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCd0b3AnKTtcbiAgICBjb25zdCB2ZXJ0aWNhbFN0eWxlID0gdG9wID8geyB0b3A6IDAgfSA6IHsgYm90dG9tOiAwIH07XG5cbiAgICBjb25zdCBob3Jpem9udGFsU3R5bGUgPSB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCdsZWZ0JylcbiAgICAgID8ge1xuICAgICAgICAgIGxlZnQ6IDAsXG4gICAgICAgIH1cbiAgICAgIDogdGhpcy50b2FzdC5wb3NpdGlvbi5pbmNsdWRlcygncmlnaHQnKVxuICAgICAgPyB7XG4gICAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgIH1cbiAgICAgIDoge1xuICAgICAgICAgIGxlZnQ6IDAsXG4gICAgICAgICAgcmlnaHQ6IDAsXG4gICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICdjZW50ZXInLFxuICAgICAgICB9O1xuICAgIHJldHVybiB7XG4gICAgICB0cmFuc2Zvcm06IGB0cmFuc2xhdGVZKCR7dGhpcy5vZmZzZXQgKiAodG9wID8gMSA6IC0xKX1weClgLFxuICAgICAgLi4udmVydGljYWxTdHlsZSxcbiAgICAgIC4uLmhvcml6b250YWxTdHlsZSxcbiAgICB9O1xuICB9XG5cbiAgZ2V0IHRvYXN0QmFyQmFzZVN0eWxlcygpIHtcbiAgICBjb25zdCB0b3AgPSB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCd0b3AnKTtcblxuICAgIGNvbnN0IGVudGVyQW5pbWF0aW9uID0gYGhvdFRvYXN0RW50ZXJBbmltYXRpb24ke1xuICAgICAgdG9wID8gJ05lZ2F0aXZlJyA6ICdQb3NpdGl2ZSdcbiAgICB9ICR7RU5URVJfQU5JTUFUSU9OX0RVUkFUSU9OfW1zIGN1YmljLWJlemllcigwLjIxLCAxLjAyLCAwLjczLCAxKSBmb3J3YXJkc2A7XG5cbiAgICBjb25zdCBleGl0QW5pbWF0aW9uID0gYGhvdFRvYXN0RXhpdEFuaW1hdGlvbiR7XG4gICAgICB0b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFWElUX0FOSU1BVElPTl9EVVJBVElPTn1tcyBmb3J3YXJkcyBjdWJpYy1iZXppZXIoMC4wNiwgMC43MSwgMC41NSwgMSkgJHt0aGlzLnRvYXN0LmR1cmF0aW9ufW1zYDtcblxuICAgIGNvbnN0IGFuaW1hdGlvbiA9IHRoaXMudG9hc3QuYXV0b0Nsb3NlID8gYCR7ZW50ZXJBbmltYXRpb259LCAke2V4aXRBbmltYXRpb259YCA6IGVudGVyQW5pbWF0aW9uO1xuXG4gICAgcmV0dXJuIHsgLi4udGhpcy50b2FzdC5zdHlsZSwgYW5pbWF0aW9uIH07XG4gIH1cblxuICBnZXQgaXNJY29uU3RyaW5nKCkge1xuICAgIHJldHVybiB0eXBlb2YgdGhpcy50b2FzdC5pY29uID09PSAnc3RyaW5nJztcbiAgfVxuXG4gIGNsb3NlKCkge1xuICAgIHRoaXMuaXNNYW51YWxDbG9zZSA9IHRydWU7XG4gICAgY29uc3QgdG9wID0gdGhpcy50b2FzdC5wb3NpdGlvbi5pbmNsdWRlcygndG9wJyk7XG5cbiAgICBjb25zdCBleGl0QW5pbWF0aW9uID0gYGhvdFRvYXN0RXhpdEFuaW1hdGlvbiR7XG4gICAgICB0b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFWElUX0FOSU1BVElPTl9EVVJBVElPTn1tcyBmb3J3YXJkcyBjdWJpYy1iZXppZXIoMC4wNiwgMC43MSwgMC41NSwgMSlgO1xuXG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBhbmltYXRlKG5hdGl2ZUVsZW1lbnQsIGV4aXRBbmltYXRpb24pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5jbG9zZSgpO1xuICAgIHdoaWxlICh0aGlzLnVubGlzdGVuZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy51bmxpc3RlbmVycy5wb3AoKSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNFeGl0QW5pbWF0aW9uKGV2OiBBbmltYXRpb25FdmVudCkge1xuICAgIHJldHVybiBldi5hbmltYXRpb25OYW1lLmluY2x1ZGVzKCdob3RUb2FzdEV4aXRBbmltYXRpb24nKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VG9hc3RBdHRyaWJ1dGVzKCkge1xuICAgIGNvbnN0IHRvYXN0QXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHRoaXMudG9hc3QuYXR0cmlidXRlcztcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh0b2FzdEF0dHJpYnV0ZXMpKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZSh0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50LCBrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==